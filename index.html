<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Card</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
    <style>
        
    </style>

    <style>
         @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap');
            
        .arabic {
            font-size: 50px;
            margin-bottom: 0px;
            font-family: 'Reem Kufi', sans-serif;
            font-weight: 100;
        }
        .malayalam {
        font-size:30px;
                font-family: "Karthika", "Noto Sans Malayalam", sans-serif;
            }
            #campus{
            font-size:20px;
            }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 20px;
            align-items:center;
            
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        input, button {
            width: 90%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }
        
        .progress-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        .progress-card h2 {
            color: #333;
        }

        .progress-card p {
            font-size: 14px;
            color: #555;
            text-align:left;
        }

        .progress-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .progress-card table, th, td {
            border: 1px solid #ddd;
        }

        .progress-card th, td {
            padding: 8px;
            text-align: center;
        }

        .progress-card th {
            background: #007bff;
            color: white;
        }
#progressCardContainer {
display:flex;
margin:auto;
    width:20cm;
        max-width:20cm;
        max-height:26cm;
        width: 100%;
        padding: 5px;
        font-size: 11px; /* Adjust font size for readability */
        text-align:center;

    }
    
    #progressard .faild{
        background: #f5352b;
            color: white;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            animation: fadeIn 1.5s ease-in-out;
    }
    #progressard .congratulations {
            background: #28a745;
            color: white;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            animation: fadeIn 1.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @media screen and (max-width: 768px) {
        container{
        width:100%;
        }
        h2{
        font-size:13px;
        }
        .arabic {
            font-size: 30px;
            margin-bottom: 0px;
            font-family: 'Reem Kufi', sans-serif;
            font-weight: 100;
        }
        .malayalam {
        font-size:19px;
                font-family: "Karthika", "Noto Sans Malayalam", sans-serif;
            }
            #campus{
            font-size:14px;
            }
    #progressCardContainer {
    width:20cm;
        max-width:20cm;
        max-height:26cm;
        width: 100%;
        padding: 5px;
        font-size: 11px; /* Adjust font size for readability */
    }

    .header {
        text-align: center;
        font-size: 11px;
    }

    .student-info {
        display: block; /* Stack elements vertically */
        text-align: center;
    }

    .table-container {
        overflow-x: auto; /* Enable horizontal scrolling for tables */
    }

    table {
        width: 100%;
        font-size: 12px; /* Reduce table font size */
    }

    .button-container {
        text-align: center;
        padding: 10px 0;
    }

    .download-btn {
        width:fit-content;
        padding: 12px;
        font-size: 16px;
    }
    .congratulations {
            background: #28a745;
            color: white;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            animation: fadeIn 1.5s ease-in-out;
        }
}

        @media print {
        .hidePrint{
        display:none;}
    #progressCardContainer {
        width: 100%;
        font-size: 14px;
    }

    table {
        page-break-inside: auto;
    }

    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
}

    </style>
</head>
<body>
    <div id="nonePrint" style="display: block;">
    
   
    
        
    <div id="searchField" class="container" style="display:block;">
        <div>
            <h1 class="arabic"
>مدرسة هداية المؤمنين</h1>
            <h2  style="margin-top:0px;margin-bottom:0.3em;" class="malayalam">ഹിദായത്തുൽ മുഅ്മിനീൻ മദ്രസ</h2>
            <h3 id="campus" style="margin-top: 0.2em;">PMSA ORPHANAGE CAMPUS KATTILANGADI</h3>
          </div>
        <h2 style="color:red">Annual Examination Result</h2>
        <input type="text" id="searchAdnumber" placeholder="Enter AD Number">
        <input type="text" id="searchClass" placeholder="Enter Class">
        <input type="text" id="searchDivision" placeholder="Enter Division">
        <button id="searchBtn">Get Result</button>
    </div>
       <div >
        <div id="printBtn" class="hidePrint" style="display:none; position:relative; margin-top:10px; margin-right:10px; justify-content: flex-end;">
            <button style="width:fit-content; text-align:center; margin-right: 5px;" onclick="printProgressCard()">Print</button>
            <button onclick="gotoSearch()" style="width:fit-content; background-color:blue; color:white;">Check Another Result</button>
        </div>
        <div id="progressCardContainer" style="display: block;"></div>
    
</div>
    </div>
</div>
    </div>
   <div id="printArea" style="display: none;">
    <div style="display: flex;justify-content: right;">
        
    <button class="hidePrint" style="width: fit-content;gap: 30px;" type="button" onclick="togglePrint();">close</button>
    <button class="download-btn hidePrint" onclick="downloadPDF()">Download PDF</button>
    
    </div>
    <div style="max-width:20cm;max-height:27cm; margin:10px;" id="printContents"></div>
    
   </div>
   
   <script>
    function gotoSearch(){
    document.getElementById("searchField").style.display="block";
    
    document.getElementById("progressCard").innerHTML ="";
    //document.getElementById("progressCardContainer").style.display="none";
    document.getElementById("printBtn").style.display="none";

    }
        function togglePrint(){
            const progressCardContainer = document.getElementById("progressCardContainer");
    const printArea = document.getElementById("printArea");
    const nonePrintElements = document.getElementById("nonePrint"); //document.querySelectorAll(".nonePrint");
            document.getElementById("nonePrint").style.display="block";
            document.getElementById("printArea").style.display="none";
            printArea.style.display = "none"; // Hide print area again
    nonePrintElements.forEach(element => element.style.display = "block");
    
        }
// Example usage in your displayProgressCard function:
//progressHTML += `<button onclick="saveProgressCardAsPDF()">Save as PDF</button>`; // Call the function
        function downloadPDF() {
            const element = document.getElementById("printContents"); // Target the progress card container
            html2pdf().from(element).save("Progress_Card.pdf");
        }


function printProgressCard() {

    const progressCardContainer = document.getElementById("progressCardContainer");
    const printArea = document.getElementById("printArea");
    const printContents = document.getElementById("printContents");

    const nonePrintElements = document.getElementById("nonePrint"); //document.querySelectorAll(".nonePrint");
    

    if (!progressCardContainer || !printArea) {
        console.error("Required elements not found.");
        return;
    }

    // Hide non-printable elements
    //nonePrintElements.forEach(element => element.style.display = "none");
        //nonePrintElements.style.display="none";
    // Copy progress card content into printArea
    printContents.innerHTML = progressCardContainer.innerHTML;
    printArea.style.display = "block"; // Show print area
    nonePrintElements.style.display="none";
    // Wait a moment before printing to allow the browser to render content
    setTimeout(() => {
        window.print();

        // Restore elements after printing
       // printArea.style.display = "none";
        //nonePrintElements.forEach(element => element.style.display = "block");
    }, 500); // 500ms delay
}

function getGrade(maxMark, obtMark) {
    const percentage = (obtMark / maxMark) * 100;

    if (percentage >= 90) {
        return "A+";
    } else if (percentage >= 80) {
        return "A";
    } else if (percentage >= 70) {
        return "B+";
    } else if (percentage >= 60) {
        return "B";
    } else if (percentage >= 50) {
        return "C+";
    } else if (percentage >= 40){
        return "C";
    }else if (percentage >= 36){
        return "D+";
    }else{
        return "D"
    }
}

    </script>
    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        document.getElementById("searchBtn").addEventListener("click", async () => {
            const adnumber = document.getElementById("searchAdnumber").value.trim();
            const studentClass = document.getElementById("searchClass").value.trim();
            const division = document.getElementById("searchDivision").value.trim();

            if (!adnumber || !studentClass || !division) {
                alert("❌ Please enter all details.");
                return;
            }
            if (parseInt(adnumber) === 4789 && division === "admin") {
alert("Admin access granted");
                    window.location.href = "csvparse.html";

                }else{

            try {
                const querySnapshot = await getDocs(query(
                    collection(db, "studentMarks"),
                    where("adnumber", "==", adnumber),
                    where("class", "==", studentClass),
                    where("division", "==", division)
                ));

                if (querySnapshot.empty) {
                    alert("❌ No records found for this student.");
                    return;
                }

                let studentData = [];
                let studentInfo = {};

                querySnapshot.forEach((doc) => {
    const data = doc.data();

    // Ensure subjects array exists
    if (Array.isArray(data.subjects)) {
        data.subjects.forEach(sub => {
            studentData.push({
                subject: sub.subject,  // Access subject inside the sub-object
                maxMark: sub.maxMark,  // Access maxMark inside the sub-object
                obtMark: sub.obtMark   // Access obtMark inside the sub-object
            });
        });
    }

                    studentInfo = {
                        name: data.name,
                        class: data.class,
                        division: data.division,
                        adnumber: data.adnumber
                    };
                });

                displayProgressCard(studentInfo, studentData);

            } catch (error) {
                console.error("❌ Error fetching student data:", error);
                alert("❌ Error fetching data: " + error.message);
            }
        }
        });
    
        function displayProgressCard(studentInfo, studentData) {
    let progressHTML = `
       <div id="progressCard">
            <h1 class="arabic" style="margin-bottom:0px;">مدرسة هداية المؤمنين</h1>
            <h2 style="margin-top:0px;margin-bottom:0.3em;" class="malayalam">ഹിദായത്തുൽ മുഅ്മിനീൻ മദ്രസ</h2>
            <h3 style="margin-top: 0.2em;">PMSA ORPHANAGE CAMPUS KATTILANGADI</h3>
            <div class="progress-card">
                <p style="display: flex; gap: 10px; font-size:16px;"><strong>Name of Student : </strong><span style="color:red; font-weight:bold;">${studentInfo.name}</span></p >
                <p style="font-size:16px;"><strong>Admission Number:</strong> <span style="color:black; font-weight:bold;">${studentInfo.adnumber}</span></p>
                <p style="font-size:16px;"><strong>Class:</strong> ${studentInfo.class} - ${studentInfo.division}</p>
                <table border="1" cellspacing="0" cellpadding="5" style="width: 100%; text-align: center;">
                    <tr>
                        <th>Subject</th>
                        <th>Max Marks</th>
                        <th>Obtained Marks</th>
                        <th>Grade</th>
                        <th>Status</th>
                    </tr>
    `;

    let totalMarks = 0;
    let obtainedMarks = 0;
    let hasFailed = false; // Flag to check if the student failed

    studentData.forEach((subject) => {
        const grade = getGrade(subject.maxMark, subject.obtMark);
        const isPassed = subject.obtMark >= 18;
        const statusIcon = isPassed ? 'P':'F';//'✔️' : '❌'; // Tick for pass, Cross for fail
        const rowStyle = isPassed ? "" : 'style="background-color: #ffcccc; font-weight: bold;"'; // Red background for fail

        if (!isPassed) {
            hasFailed = true; // Mark as failed if any subject is below 18
        }

        progressHTML += `
            <tr ${rowStyle}>
                <td>${subject.subject}</td>
                <td>${subject.maxMark}</td>
                <td>${subject.obtMark}</td>
                <td>${grade}</td> 
                <td>${statusIcon}</td>
            </tr>
        `;

        totalMarks += parseInt(subject.maxMark);
        obtainedMarks += parseInt(subject.obtMark);
    });

    let percentage = ((obtainedMarks / totalMarks) * 100).toFixed(2);

    progressHTML += `
                </table>
                <p><strong>Total Marks:</strong> ${obtainedMarks} / ${totalMarks}</p>
                <p><strong>Percentage:</strong> ${percentage}%</p>
    `;

    if (hasFailed) {
        progressHTML += `<div class="faild" style="color: red; font-weight: bold;">❌ You have failed the exam. Try again! ❌</div>`;
    } else {
        progressHTML += `<div class="congratulations hideprint" style="color: green; font-weight: bold;">🎉 Congratulations! You have passed successfully! 🎉</div>`;
    }

    progressHTML += `</div></div></div>`;

    document.getElementById("progressCardContainer").innerHTML = progressHTML;
    document.getElementById("printBtn").style.display = "flex";
    document.getElementById("searchField").style.display = "none";
}



    </script>

</body>
</html>

